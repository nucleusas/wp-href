(()=>{"use strict";!function(e){var n=wpHreflangAdminSettings,t=!1,o=e("#wp-hreflang-settings-form"),r=e("#save-settings-button"),s=e("#wp-hreflang-settings-message"),i=e("#wp-hreflang-progress-modal"),a=e("#wp-hreflang-progress-title"),c=e("#wp-hreflang-progress-desc"),l=e("#wp-hreflang-site-progress-label"),p=e("#wp-hreflang-post-progress-label"),u=e("#wp-hreflang-current-site"),d=e("#wp-hreflang-total-sites"),h=e("#wp-hreflang-current-post"),v=e("#wp-hreflang-total-posts"),g=e("#wp-hreflang-site-progress"),f=e("#wp-hreflang-post-progress"),m=e("#wp-hreflang-start-button"),w=e("#wp-hreflang-cancel-button"),_=e("#wp-hreflang-close-button"),b=e("#add-locale"),x=e("#add-archive-page");function y(e,n){s.removeClass("notice-success notice-error notice-warning notice-info").addClass("notice-"+n).html("<p>"+e+"</p>").show(),setTimeout((function(){s.fadeOut()}),5e3)}function k(){o.on("submit",(function(s){s.preventDefault(),t||function(){t=!0,r.prop("disabled",!0).text(n.i18n.processing);var s=o.serializeArray(),l={locales:{site_id:[],locale:[]},post_types:[],archive_pages:{name:[],id:[]},nonce:n.nonce};e.each(s,(function(e,n){"ignore_query_params"===n.name?l[n.name]=!0:n.name.match(/^locales\[site_id\]/)?l.locales.site_id.push(n.value):n.name.match(/^locales\[locale\]/)?l.locales.locale.push(n.value):"post_types[]"===n.name?l.post_types.push(n.value):n.name.match(/^archive_pages\[name\]/)?l.archive_pages.name.push(n.value):n.name.match(/^archive_pages\[id\]/)&&l.archive_pages.id.push(n.value)})),e.ajax({url:n.api.root+"wp-hreflang/v1/update-settings",method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",n.api.nonce)},data:JSON.stringify(l),contentType:"application/json",success:function(e){y(n.i18n.success,"success"),S(),a.text(n.i18n.rebuild_title),c.text(n.i18n.rebuild_desc),i.show()},error:function(e){var t;console.error("Error saving settings:",e),y(n.i18n.error+": "+((null===(t=e.responseJSON)||void 0===t?void 0:t.message)||"Unknown error"),"error")},complete:function(){t=!1,r.prop("disabled",!1).text(n.i18n.save_settings)}})}()})),m.on("click",(function(){t=!0,m.prop("disabled",!0).text(n.i18n.processing),w.prop("disabled",!0),e.ajax({url:n.api.root+"wp-hreflang/v1/rebuild/start",method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",n.api.nonce)},success:function(e){if(!e.success)return y(n.i18n.error+": "+e.message,"error"),S(),void i.hide();j(e.status),T(0)},error:function(e){var t;console.error("Error starting rebuild:",e),y(n.i18n.error+": "+((null===(t=e.responseJSON)||void 0===t?void 0:t.message)||"Unknown error"),"error"),S(),i.hide()}})})),w.on("click",(function(){i.hide()})),_.on("click",(function(){i.hide()})),b.on("click",N),e(document).on("click",".remove-locale",(function(){e(this).closest(".locale-row").remove()})),x.on("click",O),e(document).on("click",".remove-archive",(function(){e(this).closest(".archive-page-row").remove()})),e(document).on("blur",".archive-name-input",(function(){var n=e(this).siblings(".archive-id-input");""===n.val()&&n.val(e(this).val().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""))}))}function S(){g.css("width","0%"),f.css("width","0%"),u.text("0"),d.text("0"),h.text("0"),v.text("0"),l.text(n.i18n.site_progress),p.text(n.i18n.post_progress),m.show().prop("disabled",!1).text(n.i18n.start_rebuild),w.show(),_.hide()}function N(){var t=n.sites.map((function(e){return'<option value="'.concat(e.id,'">').concat(e.name,"</option>")})).join(""),o='\n            <div class="locale-row">\n                <select name="locales[site_id][]" class="site-select">\n                    <option value="">'.concat(n.i18n.select_site,"</option>\n                    ").concat(t,'\n                </select>\n                <input type="text" \n                    name="locales[locale][]" \n                    value="" \n                    class="locale-input" \n                    placeholder="').concat(n.i18n.locale_placeholder,'" />\n                <button type="button" class="remove-locale button">').concat(n.i18n.remove,"</button>\n            </div>\n        ");e("#wp-hreflang-locales").append(o)}function O(){var t='\n            <div class="archive-page-row">\n                <input type="text"\n                    name="archive_pages[name][]"\n                    class="archive-name-input"\n                    placeholder="'.concat(n.i18n.archive_name,'" />\n                <input type="text"\n                    name="archive_pages[id][]"\n                    class="archive-id-input"\n                    placeholder="').concat(n.i18n.archive_id,'" />\n                <button type="button" class="remove-archive button">').concat(n.i18n.remove,"</button>\n            </div>\n        ");e("#wp-hreflang-archive-pages").append(t)}function T(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e.ajax({url:n.api.root+"wp-hreflang/v1/rebuild/process",method:"POST",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",n.api.nonce)},success:function(e){if(!e.success)return t<3?(console.log("Retrying batch (".concat(t+1,"/").concat(3,")...")),void setTimeout((function(){return T(t+1)}),1e3)):(y(n.i18n.error+": "+e.message,"error"),void P());j(e.status),e.status.completed?P():setTimeout((function(){return T(0)}),100)},error:function(e){var o;if(t<3)return console.log("Network error, retrying batch (".concat(t+1,"/").concat(3,")...")),void setTimeout((function(){return T(t+1)}),1e3*(t+1));console.error("Error processing batch:",e),y(n.i18n.error+": "+((null===(o=e.responseJSON)||void 0===o?void 0:o.message)||"Unknown error"),"error"),P()}})}function j(e){var n=e.current_site_index/e.total_sites*100;u.text(e.current_site_index),d.text(e.total_sites),g.css("width",n+"%");var t=0;e.total_posts>0&&(t=e.current_post_index/e.total_posts*100),h.text(e.current_post_index),v.text(e.total_posts),f.css("width",t+"%")}function P(){t=!1,m.hide(),w.hide().prop("disabled",!1),_.show(),g.css("width","100%"),f.css("width","100%"),l.text(n.i18n.complete),p.text(n.i18n.complete)}e(document).ready((function(){k()}))}(jQuery)})();